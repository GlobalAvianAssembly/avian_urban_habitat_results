---
title: "Percentage of Regional Richness"
output: html_notebook
---

Run 'download_data.Rmd` First!

```{r}
options(na.action = "na.fail") 
```

```{r}
source("./dredge_functions.R")
```

```{r}
model_average_richness <- function(data) {
  model_average(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + urban + realm + (1|city_name), data, 4)
}
```

----------------------
Find city predictors
----------------------

```{r}
create_city_dataset <- function(mixed_model) {
  city_coeefs <- ranef(mixed_model)$city_name
  city_coeefs <- cbind(city_name = rownames(city_coeefs), city_coeefs)
  rownames(city_coeefs) <- NULL
  names(city_coeefs) <- c('name', 'response')
  
  left_join(city_coeefs, city_data)
}
```

----------------------
Merlin: Difference in richness
----------------------
```{r}
merlin_richness_result <- model_average_richness(merlin)
merlin_richness_result
```

```{r}
merlin_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm + (1|city_name), merlin)
r.squaredGLMM(merlin_mixed_model)
```

```{r}
merlin_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm, merlin)
anova(merlin_mixed_model, merlin_fixed_model)
```

```{r}
anova(merlin_mixed_model, lm(percentage_of_regional_pool_present ~ city_name, merlin))
```

```{r}
merlin_richness_sum <- model_summary('merlin', 'richness', merlin_richness_result)
merlin_richness_sum
```

```{r}
merlin_city_response <- create_city_dataset(merlin_mixed_model)
merlin_city_response[order(merlin_city_response$response), c('name', 'response')]
```

```{r}
write_csv(merlin_city_response[, c('name', 'response')], 'merlin_city_richness_intercept.csv')
```

```{r}
merlin_niche_resiliance_city_result <- model_average_for_city(merlin_city_response)
merlin_niche_resiliance_city_sum <- model_summary('merlin', 'richness', merlin_niche_resiliance_city_result)
merlin_niche_resiliance_city_sum
```

----------------------
Birdlife: Difference in richness
----------------------
```{r}
bl_richness_result <- model_average_richness(birdlife)
bl_richness_result
```

```{r}
birdlife_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + shrubs + realm + (1|city_name), birdlife)
r.squaredGLMM(birdlife_mixed_model)
```

```{r}
summary(birdlife_mixed_model)
```

```{r}
birdlife_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + shrubs + realm, birdlife)
anova(birdlife_mixed_model, birdlife_fixed_model)
```

```{r}
summary(birdlife_fixed_model)
```

```{r}
birdlife_city_response <- create_city_dataset(birdlife_mixed_model)
birdlife_city_response[order(birdlife_city_response$response), c('name', 'response')]
```

```{r}
write_csv(birdlife_city_response[, c('name', 'response')], 'birdlife_city_richness_intercept.csv')
```


```{r}
bl_richness_sum <- model_summary('birdlife', 'richness', bl_richness_result)
bl_richness_sum
```

```{r}
birdlife_niche_resiliance_city_result <- model_average_for_city(birdlife_city_response)
birdlife_niche_resiliance_city_sum <- model_summary('birdlife', 'richness', birdlife_niche_resiliance_city_result)
birdlife_niche_resiliance_city_sum
```

----------------------
Both: Difference in richness
----------------------
```{r}
both_richness_result <- model_average_richness(both)
both_richness_result
```

```{r}
both_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm + (1|city_name), both)
r.squaredGLMM(both_mixed_model)
```

```{r}
both_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm, both)
anova(both_mixed_model, both_fixed_model)
```

```{r}
both_richness_sum <- model_summary('both', 'richness', both_richness_result)
both_richness_sum
```
```{r}
both_city_response <- create_city_dataset(both_mixed_model)
both_city_response[order(both_city_response$response), c('name', 'response')]
```

```{r}
write_csv(both_city_response[, c('name', 'response')], 'both_city_richness_intercept.csv')
```

```{r}
both_niche_resiliance_city_result <- model_average_for_city(both_city_response)
both_niche_resiliance_city_sum <- model_summary('both', 'richness', both_niche_resiliance_city_result)
both_niche_resiliance_city_sum
```

----------------------
Either: Difference in richness
----------------------
```{r}
either_richness_result <- model_average_richness(either)
either_richness_result
```

```{r}
either_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm + (1|city_name), either)
r.squaredGLMM(either_mixed_model)
```

```{r}
either_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm, either)
anova(either_mixed_model, either_fixed_model)
```

```{r}
either_richness_sum <- model_summary('either', 'richness', either_richness_result)
either_richness_sum
```

```{r}
either_city_response <- create_city_dataset(either_mixed_model)
either_city_response[order(either_city_response$response), c('name', 'response')]
```

```{r}
write_csv(either_city_response[, c('name', 'response')], 'either_city_richness_intercept.csv')
```

```{r}
either_niche_resiliance_city_result <- model_average_for_city(either_city_response)
either_niche_resiliance_city_sum <- model_summary('either', 'richness', either_niche_resiliance_city_result)
either_niche_resiliance_city_sum
```

----------------------
Full result
----------------------
```{r}
richness_all <- full_join(full_join(merlin_richness_sum, bl_richness_sum), full_join(both_richness_sum, either_richness_sum))
write_csv(richness_all, "richness_result.csv")
```

```{r}
ggplot(merlin, aes(x = herbaceous_wetland, y = percentage_of_regional_pool_present, colour = realm)) + geom_smooth(method = "lm", se = F) + geom_point(alpha = 0.1) + theme_bw()
```

```{r}
ggplot(merlin, aes(x = open_forest, y = percentage_of_regional_pool_present, colour = realm)) + geom_smooth(method = "lm", se = F) + geom_point(alpha = 0.1) + theme_bw()
```

```{r}
ggplot(merlin, aes(x = cultivated, y = percentage_of_regional_pool_present, colour = realm)) + geom_smooth(method = "lm", se = F) + geom_point(alpha = 0.1) + theme_bw()
```




