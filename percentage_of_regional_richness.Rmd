---
title: "Percentage of Regional Richness"
output: html_notebook
---

Run 'download_data.Rmd` First!

```{r setup}
options(na.action = "na.fail") 

library(tidyverse)
library(dplyr)

source("./helper__dredge_functions.R")
```

```{r}
model_average_richness <- function(data) {
  model_average(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + urban + realm + (1|city_name), data, 4)
}
```

----------------------
Find city predictors
----------------------

```{r}
create_city_dataset <- function(mixed_model) {
  city_coeefs <- ranef(mixed_model)$city_name
  city_coeefs <- cbind(city_name = rownames(city_coeefs), city_coeefs)
  rownames(city_coeefs) <- NULL
  names(city_coeefs) <- c('name', 'response')
  
  left_join(city_coeefs, city_data)
}
```

----------------------
Merlin: Difference in richness
----------------------
```{r}
merlin_richness_result <- model_average_richness(merlin)
merlin_richness_result
```

```{r}
merlin_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm + (1|city_name), merlin)
r.squaredGLMM(merlin_mixed_model)
```

```{r}
merlin_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm, merlin)
anova(merlin_mixed_model, merlin_fixed_model)
```

```{r}
anova(merlin_mixed_model, lm(percentage_of_regional_pool_present ~ city_name, merlin))
```


```{r}
merlin_richness_sum <- model_summary('merlin', 'richness', merlin_richness_result)
merlin_richness_sum
```

```{r}
merlin_city_response <- create_city_dataset(merlin_mixed_model)
merlin_city_response[order(merlin_city_response$response), c('name', 'response')]
```

```{r}
write_csv(merlin_city_response[, c('name', 'response')], 'percentage_of_regional_richness__output__merlin_city_richness_intercept.csv')
```


```{r}
summary(merlin_mixed_model)
```

```{r}
merlin_richness_plot <- merlin_richness_sum[merlin_richness_sum$model == 'full',]
merlin_richness_plot$explanatory <- factor(merlin_richness_plot$explanatory, levels = c('closed_forest', 'open_forest', 'shrubs', 'herbaceous_vegetation', 'herbaceous_wetland', 'permanent_water', 'cultivated', 'urban', 'mean_elevation_scaled', 'elevation_delta_scaled', 'realmAfrotropic', 'realmAustralasia', 'realmIndomalayan', 'realmNearctic', 'realmNeotropic'))
merlin_richness_plot$type <- 'Landcover'
merlin_richness_plot$type[merlin_richness_plot$explanatory %in% c('mean_elevation_scaled', 'elevation_delta_scaled')] <- 'Elevation'
merlin_richness_plot$type[merlin_richness_plot$explanatory %in% c('realmAfrotropic', 'realmAustralasia', 'realmIndomalayan', 'realmNearctic', 'realmNeotropic')] <- 'Realm'

ggplot(merlin_richness_plot, aes(y=explanatory, x=richness_merlin_estimate, colour = type)) + 
  geom_line() +
  geom_point()+
  geom_errorbar(aes(xmin=richness_merlin_estimate-richness_merlin_error, xmax=richness_merlin_estimate+richness_merlin_error), width=.2,
                 position=position_dodge(0.05)) +
  scale_y_discrete(
    limits = rev(levels(merlin_richness_plot$explanatory)), 
    labels = c('closed_forest' = 'Closed forest', 'open_forest' = 'Open forest', 'shrubs' = 'Shrubs', 'herbaceous_vegetation' = 'Herbaceous vegetation', 'herbaceous_wetland' = 'Herbaceous wetland', 'permanent_water' = 'Permanent water', 'cultivated' = 'Cultivated', 'urban' = 'Urban', 'mean_elevation_scaled' = 'Mean elevation scaled', 'elevation_delta_scaled' = 'Elevation delta scaled', 'realmAfrotropic' = 'Afrotropic', 'realmAustralasia' = 'Austaliasia', 'realmIndomalayan' = 'Indomalayan', 'realmNearctic' = 'Nearctic', 'realmNeotropic' = 'Neotropic')) +
  theme_bw() +
  geom_vline(xintercept=0, linetype="dotted") +
  guides(colour=guide_legend(title="Explanatory type")) + xlab('Estimate ± Standard Error') + ylab('Explanatory')

ggsave('percentage_of_regional_pool__output__merlin_richness_result.jpg')
```


----------------------
Birdlife: Difference in richness
----------------------
```{r}
bl_richness_result <- model_average_richness(birdlife)
bl_richness_result
```

```{r}
birdlife_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + shrubs + realm + (1|city_name), birdlife)
r.squaredGLMM(birdlife_mixed_model)
```

```{r}
summary(birdlife_mixed_model)
```

```{r}
birdlife_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + shrubs + realm, birdlife)
anova(birdlife_mixed_model, birdlife_fixed_model)
```

```{r}
summary(birdlife_fixed_model)
```

```{r}
birdlife_city_response <- create_city_dataset(birdlife_mixed_model)
birdlife_city_response[order(birdlife_city_response$response), c('name', 'response')]
```

```{r}
write_csv(birdlife_city_response[, c('name', 'response')], 'percentage_of_regional_richness__output__birdlife_city_richness_intercept.csv')
```


```{r}
bl_richness_sum <- model_summary('birdlife', 'richness', bl_richness_result)
bl_richness_sum
```

```{r}
summary(birdlife_mixed_model)
```

```{r}
birdlife_richness_plot <- bl_richness_sum[bl_richness_sum$model == 'full',]
birdlife_richness_plot$explanatory <- factor(birdlife_richness_plot$explanatory, levels = c('closed_forest', 'open_forest', 'shrubs', 'herbaceous_vegetation', 'herbaceous_wetland', 'permanent_water', 'cultivated', 'urban', 'mean_elevation_scaled', 'elevation_delta_scaled', 'realmAfrotropic', 'realmAustralasia', 'realmIndomalayan', 'realmNearctic', 'realmNeotropic'))
birdlife_richness_plot$type <- 'Landcover'
birdlife_richness_plot$type[birdlife_richness_plot$explanatory %in% c('mean_elevation_scaled', 'elevation_delta_scaled')] <- 'Elevation'
birdlife_richness_plot$type[birdlife_richness_plot$explanatory %in% c('realmAfrotropic', 'realmAustralasia', 'realmIndomalayan', 'realmNearctic', 'realmNeotropic')] <- 'Realm'

ggplot(birdlife_richness_plot, aes(y=explanatory, x=richness_birdlife_estimate, colour = type)) + 
  geom_line() +
  geom_point()+
  geom_errorbar(aes(xmin=richness_birdlife_estimate-richness_birdlife_error, xmax=richness_birdlife_estimate+richness_birdlife_error), width=.2,
                 position=position_dodge(0.05)) +
  scale_y_discrete(
    limits = rev(levels(birdlife_richness_plot$explanatory)), 
    labels = c('closed_forest' = 'Closed forest', 'open_forest' = 'Open forest', 'shrubs' = 'Shrubs', 'herbaceous_vegetation' = 'Herbaceous vegetation', 'herbaceous_wetland' = 'Herbaceous wetland', 'permanent_water' = 'Permanent water', 'cultivated' = 'Cultivated', 'urban' = 'Urban', 'mean_elevation_scaled' = 'Mean elevation scaled', 'elevation_delta_scaled' = 'Elevation delta scaled', 'realmAfrotropic' = 'Afrotropic', 'realmAustralasia' = 'Austaliasia', 'realmIndomalayan' = 'Indomalayan', 'realmNearctic' = 'Nearctic', 'realmNeotropic' = 'Neotropic')) +
  theme_bw() +
  geom_vline(xintercept=0, linetype="dotted") +
  guides(colour=guide_legend(title="Explanatory type")) + xlab('Estimate ± Standard Error') + ylab('Explanatory')

ggsave('percentage_of_regional_pool__output__birdlife_richness_result.jpg')
```

----------------------
Both: Difference in richness
----------------------
```{r}
both_richness_result <- model_average_richness(both)
both_richness_result
```

```{r}
both_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm + (1|city_name), both)
r.squaredGLMM(both_mixed_model)
```

```{r}
both_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + elevation_delta_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm, both)
anova(both_mixed_model, both_fixed_model)
```

```{r}
both_richness_sum <- model_summary('both', 'richness', both_richness_result)
both_richness_sum
```

```{r}
both_city_response <- create_city_dataset(both_mixed_model)
both_city_response[order(both_city_response$response), c('name', 'response')]
```

```{r}
write_csv(both_city_response[, c('name', 'response')], 'percentage_of_regional_richness__output__both_city_richness_intercept.csv')
```

```{r}
both_niche_resiliance_city_result <- model_average_for_city(both_city_response)
both_niche_resiliance_city_sum <- model_summary('both', 'richness', both_niche_resiliance_city_result)
both_niche_resiliance_city_sum
```

----------------------
Either: Difference in richness
----------------------
```{r}
either_richness_result <- model_average_richness(either)
either_richness_result
```

```{r}
either_mixed_model <- lmer(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm + (1|city_name), either)
r.squaredGLMM(either_mixed_model)
```

```{r}
either_fixed_model <- lm(percentage_of_regional_pool_present ~ mean_elevation_scaled + closed_forest + cultivated + herbaceous_vegetation + herbaceous_wetland + open_forest + permanent_water + shrubs + realm, either)
anova(either_mixed_model, either_fixed_model)
```

```{r}
either_richness_sum <- model_summary('either', 'richness', either_richness_result)
either_richness_sum
```

```{r}
either_city_response <- create_city_dataset(either_mixed_model)
either_city_response[order(either_city_response$response), c('name', 'response')]
```

```{r}
write_csv(either_city_response[, c('name', 'response')], 'percentage_of_regional_richness__output__either_city_richness_intercept.csv')
```

```{r}
either_niche_resiliance_city_result <- model_average_for_city(either_city_response)
either_niche_resiliance_city_sum <- model_summary('either', 'richness', either_niche_resiliance_city_result)
either_niche_resiliance_city_sum
```

----------------------
Full result
----------------------
```{r}
richness_all <- full_join(full_join(merlin_richness_sum, bl_richness_sum), full_join(both_richness_sum, either_richness_sum))
write_csv(richness_all, "percentage_of_regional_richness__output__richness_result.csv")
richness_all
```




---------------------------------------
Additional figures
---------------------------------------

```{r}
library(tidyr)
library(ggplot2)
library(ggpubr)
```

```{r}
environment <- merlin[,c('closed_forest', 'cultivated', 'herbaceous_vegetation', 'herbaceous_wetland', 'open_forest', 'permanent_water', 'shrubs', 'urban')]
names(environment) <- c('Closed Forest', 'Cultivated', 'Herbaceous Vegetation', 'Herbaceous Wetland', 'Open Forest', 'Permanent Water', 'Shurbs', 'Urban')
landcover <- gather(environment, landcover, proportion)

ggplot(landcover, aes(x = landcover, y = proportion)) + geom_boxplot() + xlab('Landcover Class') + ylab('Proportion in 5 km around sites') +
  scale_x_discrete(labels = scales::wrap_format(10)) + theme_bw() + labs(title = "Landcover Proportions")

ggsave("percentage_of_regional_richness__output__som_landcover_proportions.jpg")
```

```{r}
ggarrange(
  ggplot(merlin, aes(y = elevation_delta)) + geom_boxplot() + xlab('Elevation Delta') + ylab('Average Metres in 5 km around sites') +
    scale_x_discrete(labels = scales::wrap_format(10)) + theme_bw(),
  ggplot(merlin, aes(y = mean_elevation)) + geom_boxplot() + xlab('Mean Elevation') + ylab('Average Metres in 5 km around sites') +
    scale_x_discrete(labels = scales::wrap_format(10)) + theme_bw()
)

ggsave("percentage_of_regional_richness__output__som_elevations.jpg")
```



