---
title: "Analysis of phylogeny"
output: html_notebook
---

```{r setup}
library(phytools)
library(dplyr)
library(tidyverse)
rm(list = ls())
```

--------------------------------
- Species analysis
--------------------------------
- Species present in birdlife regional pool.


Load a maximum clade credibility tree from jetz
```{r}
tree <- read.tree("./phylogeny__input__stage2_hackett_mcc_no_neg.tre")
```

Load BirdLife regional pool species and city data
```{r}
birdlife_species_raw <- read_csv('./phylogeny__input__birdlife_species_presence.csv')
```

Species from birdlife pool not in tree
```{r}
birdlife_species_raw[!birdlife_species_raw$jetz_scientific_name %in% tree$tip.label,]
```

Format birdlife data, using only species in tree
```{r}
birdlife_species_input <- birdlife_species_raw[birdlife_species_raw$jetz_scientific_name %in% tree$tip.label,]
birdlife_species_pruned <- ladderize(drop.tip(tree, setdiff(tree$tip.label, birdlife_species_input$jetz_scientific_name)))

species_response <- birdlife_species_input$presence_ratio
names(species_response) <- birdlife_species_input$jetz_scientific_name

head(species_response)
```

Look at average presence ratio per family
```{r}
birdlife_species_input %>% group_by(birdlife_v3_family_name_english) %>% summarise(averge_adaptation = mean(presence_ratio), number = n()) %>% arrange(averge_adaptation)
```

Run the analysis on birdlife species data
```{r}
birdlife_species_phylo_signal <- phylosig(birdlife_species_pruned, species_response, method="lambda", test=TRUE)
birdlife_species_phylo_signal
```

```{r}
birdlife_species_input
```

Show the results for species
```{r}
birdlife_species_continuous_trait_evolution <- contMap(birdlife_species_pruned, species_response, outline=FALSE, fsize=0.05, lwd=0.3)
```

Produce a circular plot with family name arcs over species
----------------------------------------------------

Change colour ramp
```{r}
colourCount <- length(birdlife_species_continuous_trait_evolution$cols)
birdlife_species_continuous_trait_evolution$cols[1:colourCount]<-colorRampPalette(c("#FFC20A","#0C7BDC"), space="Lab")(colourCount)
```

To produce family names as arcs over species
function from: <http://blog.phytools.org/2017/03/clade-labels-on-circular-fan-tree.html> adapted due to: <https://github.com/liamrevell/phytools/issues/79>

```{r}
library(plotrix)
arc.cladelabels.fixed <- function(tree=NULL,text,node=NULL,ln.offset=1.02,
	lab.offset=1.06,cex=1,orientation="curved",...){
	obj<-get("last_plot.phylo",envir=.PlotPhyloEnv)
	if(obj$type!="fan") stop("method works only for type=\"fan\"")
	h<-max(sqrt(obj$xx^2+obj$yy^2))
	if(hasArg(mark.node)) mark.node<-list(...)$mark.node
	else mark.node<-TRUE
	if(hasArg(interactive)) interactive<-list(...)$interactive
	else {
		if(is.null(node)) interactive<-TRUE
		else interactive<-FALSE
	}
	if(interactive) node<-getnode()
	if(hasArg(lwd)) lwd<-list(...)$lwd
	else lwd<-par()$lwd
	if(hasArg(col)) col<-list(...)$col
	else col<-par()$col
	if(hasArg(lend)) lend<-list(...)$lend
	else lend<-par()$lend
	if(hasArg(clockwise)) clockwise<-list(...)$clockwise
	else clockwise<-TRUE
	if(hasArg(n)) n<-list(...)$n
	else n<-0.05
	if(mark.node) points(obj$xx[node],obj$yy[node],pch=21,
		bg="red")
	if(is.null(tree)){
		tree<-list(edge=obj$edge,tip.label=1:obj$Ntip,
			Nnode=obj$Nnode)
		class(tree)<-"phylo"
	}
	d<-getDescendants(tree,node)
	d<-sort(d[d<=Ntip(tree)])
	
	deg<-atan(obj$yy[d]/obj$xx[d])*180/pi
	
	ii<-intersect(which(obj$yy[d]>=0),which(obj$xx[d]<0))
	deg[ii]<-180+deg[ii]
	
	ii<-intersect(which(obj$yy[d]<0),which(obj$xx[d]<0))
	deg[ii]<-180+deg[ii]
	
	ii<-intersect(which(obj$yy[d]<0),which(obj$xx[d]>=0))
	deg[ii]<-360+deg[ii]
	
	deg1 <- min(deg, na.rm = T)
	deg2 <- max(deg, na.rm = T)
	#draw.arc(x=0,y=0,radius=ln.offset*h,deg1=deg1, deg2=deg2,lwd=lwd,col=col,lend=lend,n=n)
	
	if(orientation=="curved")
		arctext(text, radius=lab.offset*h, middle=mean(range(deg * pi/180, na.rm = T)), cex=cex, clockwise=clockwise)
	else if(orientation=="horizontal") {
	  deg_med <- median(deg, na.rm = T)
		x0<-lab.offset * cos(deg_med*pi/180)*h
		y0<-lab.offset * sin(deg_med*pi/180)*h
		text(x=x0,y=y0,label=text,
		adj=c(if(x0>=0) 0 else 1,if(y0>=0) 0 else 1),
		offset=0,cex=cex)
	}
}
```

All family names present in CTE
```{r}
sort(unique(birdlife_species_input$birdlife_v3_family_name_english))
```

Where do the labels appear on the plot
```{r}
birdlife_jitter_down = c('Orioles and figbirds', 'Long-tailed Tits', 'Honeyguides', 'Ground-hornbills', 'Sunbirds', 'New World blackbirds', 'Mockingbirds and thrashers', 'Grosbeaks, saltators and allies', 'Nightjars', 'Ducks, geese and swans', 'Treecreepers', 'Guans and curassows', 'Thrushes', 'Grouse, pheasants and partridges', 'Helmetshrikes, bushshrikes and puffbacks', 'Starlings', 'Jacanas', 'New World warblers', 'Kingfishers', 'Antthrushes and antpittas', 'Pardalotes', 'Honeyeaters', 'Vireos and allies', 'Australasian babblers', 'Vireos and allies', 'Shrike-tits', 'Australasian wrens', 'Woodswallows', 'Shrike-flycatchers, wattle-eyes and batises', 'White-eyes', 'Frogmouths', 'Woodpeckers', 'Pardalotes', 'Tits and chickadees', 'Motmots', 'Accentors', 'Sparrows, snowfinches and allies', 'Herons and egrets', 'Drongos', 'Trogons', 'Manakins', 'Babblers and parrotbills', 'Sandgrouse', 'Old World warblers')

birdlife_jitter_down_down = c('Pardalotes', 'Antthrushes and antpittas', 'Rollers', 'Buttonquails', 'Swallows and martins', 'Guineafowl', 'Gnateaters', 'Shrike-flycatchers, wattle-eyes and batises', 'Turacos', 'Lyrebirds', 'Flowerpeckers', 'Penduline-tits', 'Waxbills, grass finches, munias and allies')

birdlife_jitter_up = c('Wrens', 'Screamers', 'Coursers and pratincoles', 'Butcherbirds', 'Indigobirds and allies', 'Antbirds', 'Bee-eaters', 'Gnateaters', 'Rails, crakes and allies', 'Tinamous', 'Cuckoo-shrikes', 'Storks', 'Painted-snipes', 'Wagtails and pipits', 'Weavers and allies', 'Puffbirds', 'Ovenbirds', 'Osprey, kites, hawks and eagles', 'Waxwings', 'Bustards', 'Australian treecreepers', 'Cuckoos', 'Crows and jays', 'Cotingas', 'Chats and Old World flycatchers', 'Flamingos', 'Parrots', 'Stilts and avocets')

birdlife_jitter_up_up = c('Larks', 'Broadbills', 'Butcherbirds', 'Woodhoopoes', 'Toucans and barbets', 'New World vultures', 'Honeyeaters', 'Anhingas', 'Australasian robins', 'Lyrebirds', 'Sparrows, snowfinches and allies', 'Ibises and spoonbills', 'Whipbirds, wedgebills and jewel-babblers', 'Leafbirds', 'Shrikes', 'Falcons and caracaras')

birdlife_jitter_up_up_up = c('Oystercatchers', 'Pelicans', 'Thick-knees', 'Goldcrests and kinglets')
```


```{r}
plot(birdlife_species_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.01, 1), lwd = c(0.1, 1), leg.txt="Cities/Regional Pools")

for(family in unique(birdlife_species_input$birdlife_v3_family_name_english)) {
  col = "black"
  lab.offset = 1.04
  ln.offset = 1.00
  
  if (family %in% birdlife_jitter_down) {
    lab.offset = 1.025
  }
  
  if (family %in% birdlife_jitter_up) {
    lab.offset = 1.055
  }
  
  if (family %in% birdlife_jitter_up_up) {
    lab.offset = 1.07
  }
  
  if (family %in% birdlife_jitter_up_up_up) {
    lab.offset = 1.085
  }
  
  if (family %in% birdlife_jitter_down_down) {
    lab.offset = 1.01
  }
  
  tips <- birdlife_species_input$jetz_scientific_name[birdlife_species_input$birdlife_v3_family_name_english == family]
  node <- findMRCA(tree, tips)
  tryCatch(
    expr = {
      arc.cladelabels.fixed(text=family, node=node, tree = tree, cex = 0.2, mark.node = F, col = col, lab.offset = lab.offset, ln.offset = ln.offset)
    },
    error=function(e){}
  )
}
```

Save the results

```{r}
pdf(file="phylogeny__output__birdlife_species_tree.pdf")
plot(birdlife_species_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.01, 0.5), lwd = c(0.1, 1), leg.txt="Cities/Regional Pools")

for(family in unique(birdlife_species_input$birdlife_v3_family_name_english)) {
  col = "black"
  lab.offset = 1.04
  ln.offset = 1.00
  
  if (family %in% birdlife_jitter_down) {
    lab.offset = 1.025
  }
  
  if (family %in% birdlife_jitter_up) {
    lab.offset = 1.055
  }
  
  if (family %in% birdlife_jitter_up_up) {
    lab.offset = 1.07
  }
  
  if (family %in% birdlife_jitter_up_up_up) {
    lab.offset = 1.085
  }
  
  if (family %in% birdlife_jitter_down_down) {
    lab.offset = 1.01
  }
  
  tips <- birdlife_species_input$jetz_scientific_name[birdlife_species_input$birdlife_v3_family_name_english == family]
  node <- findMRCA(tree, tips)
  tryCatch(
    expr = {
      arc.cladelabels.fixed(text=family, node=node, tree = tree, cex = 0.2, mark.node = F, col = col, lab.offset = lab.offset, ln.offset = ln.offset)
    },
    error=function(e){}
  )
}
dev.off()
```

--------------------------------
- Family analysis
--------------------------------
Families present in birdlife regional pool.

Load a maximum clade credibility tree from jetz
```{r}
ftree <- read.tree("./phylogeny__input__family_tree_18Aug2020.tre")
```

Load BirdLife regional pool family and city data
```{r}
birdlife_family_raw <- read_csv('./phylogeny__input__birdlife_family_presence.csv')
head(birdlife_family_raw)
```


Species from birdlife pool not in tree
```{r}
birdlife_family_raw[!birdlife_family_raw$birdlife_v3_family_name %in% ftree$tip.label,]
```


Format birdlife data, using only species in tree
```{r}
birdlife_family_input <- birdlife_family_raw[birdlife_family_raw$birdlife_v3_family_name %in% ftree$tip.label,]
birdlife_family_pruned <- ladderize(drop.tip(ftree, setdiff(ftree$tip.label, birdlife_family_input$birdlife_v3_family_name)))

family_response <- birdlife_family_input$presence_ratio
names(family_response) <- birdlife_family_input$birdlife_v3_family_name

family_response
```

```{r}
birdlife_family_phylo_signal <- phylosig(birdlife_family_pruned, family_response, method="lambda", test=TRUE)
birdlife_family_phylo_signal
```

Show the results for families
```{r}
birdlife_family_continuous_trait_evolution <- contMap(birdlife_family_pruned, family_response, outline=FALSE, fsize=0.05, lwd=0.3)
```
Change colour ramp
```{r}
colourCount <- length(birdlife_family_continuous_trait_evolution$cols)
birdlife_family_continuous_trait_evolution$cols[1:colourCount]<-colorRampPalette(c("#02e3f7","#f70212"), space="Lab")(colourCount)
```

```{r}
plot(birdlife_family_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.5, 1), lwd = c(0.5, 1), leg.txt="Cities/Regional Pools")
```

Save the results

```{r}
jpeg(file="phylogeny__output__birdlife_family_tree.jpg", width = 2056, height=2056)
plot(birdlife_family_continuous_trait_evolution, type="fan", outline=FALSE, fsize=2, lwd = 4, cex.legend=0.5, leg.txt="Cities/regional pools")
dev.off()
```

```{r}
birdlife_family_input[order(-birdlife_family_input$presence_ratio),c('birdlife_v3_family_name', 'presence_ratio')]
```
