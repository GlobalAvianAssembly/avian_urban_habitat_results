---
title: "Analysis of phylogeny"
output: html_notebook
---

```{r setup}
library(phytools)
library(dplyr)
library(tidyverse)
rm(list = ls())
```

Load a maximum clade credibility tree from jetz

```{r}
tree <- read.tree("./phylogeny__input__stage2_hackett_mcc_no_neg.tre")
```

Load BirdLife regional pool and city data

```{r}
birdlife_raw <- read_csv('./phylogeny__input__birdlife_city_presence.csv')
```

Species from birdlife pool not in tree

```{r}
birdlife_raw[!birdlife_raw$jetz_scientific_name %in% tree$tip.label,]
```

Format birdlife data

```{r}
birdlife_input <- birdlife_raw[birdlife_raw$jetz_scientific_name %in% tree$tip.label,]
birdlife_pruned <- ladderize(drop.tip(tree, setdiff(tree$tip.label, birdlife_input$jetz_scientific_name)))

birdlife <- birdlife_input$presence_ratio
names(birdlife) <- birdlife_input$jetz_scientific_name

head(birdlife)
```

Run the analysis on birdlife

```{r}
birdlife_phylo_signal <- phylosig(birdlife_pruned, birdlife, method="lambda", test=TRUE)
birdlife_phylo_signal
```

```{r}
birdlife_input
```

```{r}
birdlife_input %>% group_by(birdlife_v3_family_name_english) %>% summarise(averge_adaptation = mean(presence_ratio), number = n()) %>% arrange(averge_adaptation)
```

Show the results for birdlife

```{r}
birdlife_continuous_trait_evolution <- contMap(birdlife_pruned, birdlife, outline=FALSE, fsize=0.05, lwd=0.3)
```
```{r}
 
```

Change colour ramp

```{r}
colourCount <- length(birdlife_continuous_trait_evolution$cols)
birdlife_continuous_trait_evolution$cols[1:colourCount]<-colorRampPalette(c("#FFC20A","#0C7BDC"), space="Lab")(colourCount)
```

function from: <http://blog.phytools.org/2017/03/clade-labels-on-circular-fan-tree.html> adapted due to: <https://github.com/liamrevell/phytools/issues/79>

```{r}
library(plotrix)
arc.cladelabels.fixed <- function(tree=NULL,text,node=NULL,ln.offset=1.02,
	lab.offset=1.06,cex=1,orientation="curved",...){
	obj<-get("last_plot.phylo",envir=.PlotPhyloEnv)
	if(obj$type!="fan") stop("method works only for type=\"fan\"")
	h<-max(sqrt(obj$xx^2+obj$yy^2))
	if(hasArg(mark.node)) mark.node<-list(...)$mark.node
	else mark.node<-TRUE
	if(hasArg(interactive)) interactive<-list(...)$interactive
	else {
		if(is.null(node)) interactive<-TRUE
		else interactive<-FALSE
	}
	if(interactive) node<-getnode()
	if(hasArg(lwd)) lwd<-list(...)$lwd
	else lwd<-par()$lwd
	if(hasArg(col)) col<-list(...)$col
	else col<-par()$col
	if(hasArg(lend)) lend<-list(...)$lend
	else lend<-par()$lend
	if(hasArg(clockwise)) clockwise<-list(...)$clockwise
	else clockwise<-TRUE
	if(hasArg(n)) n<-list(...)$n
	else n<-0.05
	if(mark.node) points(obj$xx[node],obj$yy[node],pch=21,
		bg="red")
	if(is.null(tree)){
		tree<-list(edge=obj$edge,tip.label=1:obj$Ntip,
			Nnode=obj$Nnode)
		class(tree)<-"phylo"
	}
	d<-getDescendants(tree,node)
	d<-sort(d[d<=Ntip(tree)])
	
	deg<-atan(obj$yy[d]/obj$xx[d])*180/pi
	
	ii<-intersect(which(obj$yy[d]>=0),which(obj$xx[d]<0))
	deg[ii]<-180+deg[ii]
	
	ii<-intersect(which(obj$yy[d]<0),which(obj$xx[d]<0))
	deg[ii]<-180+deg[ii]
	
	ii<-intersect(which(obj$yy[d]<0),which(obj$xx[d]>=0))
	deg[ii]<-360+deg[ii]
	
	deg1 <- min(deg, na.rm = T)
	deg2 <- max(deg, na.rm = T)
	#draw.arc(x=0,y=0,radius=ln.offset*h,deg1=deg1, deg2=deg2,lwd=lwd,col=col,lend=lend,n=n)
	
	if(orientation=="curved")
		arctext(text, radius=lab.offset*h, middle=mean(range(deg * pi/180, na.rm = T)), cex=cex, clockwise=clockwise)
	else if(orientation=="horizontal") {
	  deg_med <- median(deg, na.rm = T)
		x0<-lab.offset * cos(deg_med*pi/180)*h
		y0<-lab.offset * sin(deg_med*pi/180)*h
		text(x=x0,y=y0,label=text,
		adj=c(if(x0>=0) 0 else 1,if(y0>=0) 0 else 1),
		offset=0,cex=cex)
	}
}
```

```{r}
sort(unique(birdlife_input$birdlife_v3_family_name_english))
```

```{r}
birdlife_jitter_down = c('Orioles and figbirds', 'Long-tailed Tits', 'Honeyguides', 'Ground-hornbills', 'Sunbirds', 'New World blackbirds', 'Mockingbirds and thrashers', 'Grosbeaks, saltators and allies', 'Nightjars', 'Ducks, geese and swans', 'Treecreepers', 'Guans and curassows', 'Thrushes', 'Grouse, pheasants and partridges', 'Helmetshrikes, bushshrikes and puffbacks', 'Starlings', 'Jacanas', 'New World warblers', 'Kingfishers', 'Antthrushes and antpittas', 'Pardalotes', 'Honeyeaters', 'Vireos and allies', 'Australasian babblers', 'Vireos and allies', 'Shrike-tits', 'Australasian wrens', 'Woodswallows', 'Shrike-flycatchers, wattle-eyes and batises', 'White-eyes', 'Frogmouths', 'Woodpeckers', 'Pardalotes', 'Tits and chickadees', 'Motmots', 'Accentors', 'Sparrows, snowfinches and allies', 'Herons and egrets', 'Drongos', 'Trogons', 'Manakins', 'Babblers and parrotbills', 'Sandgrouse', 'Old World warblers')

birdlife_jitter_down_down = c('Pardalotes', 'Antthrushes and antpittas', 'Rollers', 'Buttonquails', 'Swallows and martins', 'Guineafowl', 'Gnateaters', 'Shrike-flycatchers, wattle-eyes and batises', 'Turacos', 'Lyrebirds', 'Flowerpeckers', 'Penduline-tits', 'Waxbills, grass finches, munias and allies')

birdlife_jitter_up = c('Wrens', 'Screamers', 'Coursers and pratincoles', 'Butcherbirds', 'Indigobirds and allies', 'Antbirds', 'Bee-eaters', 'Gnateaters', 'Rails, crakes and allies', 'Tinamous', 'Cuckoo-shrikes', 'Storks', 'Painted-snipes', 'Wagtails and pipits', 'Weavers and allies', 'Puffbirds', 'Ovenbirds', 'Osprey, kites, hawks and eagles', 'Waxwings', 'Bustards', 'Australian treecreepers', 'Cuckoos', 'Crows and jays', 'Cotingas', 'Chats and Old World flycatchers', 'Flamingos', 'Parrots', 'Stilts and avocets')

birdlife_jitter_up_up = c('Larks', 'Broadbills', 'Butcherbirds', 'Woodhoopoes', 'Toucans and barbets', 'New World vultures', 'Honeyeaters', 'Anhingas', 'Australasian robins', 'Lyrebirds', 'Sparrows, snowfinches and allies', 'Ibises and spoonbills', 'Whipbirds, wedgebills and jewel-babblers', 'Leafbirds', 'Shrikes', 'Falcons and caracaras')

birdlife_jitter_up_up_up = c('Oystercatchers', 'Pelicans', 'Thick-knees', 'Goldcrests and kinglets')
```



```{r}
plot(birdlife_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.01, 1), lwd = c(0.1, 1), leg.txt="Cities/Regional Pools")

for(family in unique(birdlife_input$birdlife_v3_family_name_english)) {
  col = "black"
  lab.offset = 1.04
  ln.offset = 1.00
  
  if (family %in% birdlife_jitter_down) {
    lab.offset = 1.025
  }
  
  if (family %in% birdlife_jitter_up) {
    lab.offset = 1.055
  }
  
  if (family %in% birdlife_jitter_up_up) {
    lab.offset = 1.07
  }
  
  if (family %in% birdlife_jitter_up_up_up) {
    lab.offset = 1.085
  }
  
  if (family %in% birdlife_jitter_down_down) {
    lab.offset = 1.01
  }
  
  tips <- birdlife_input$jetz_scientific_name[birdlife_input$birdlife_v3_family_name_english == family]
  node <- findMRCA(tree, tips)
  tryCatch(
    expr = {
      arc.cladelabels.fixed(text=family, node=node, tree = tree, cex = 0.2, mark.node = F, col = col, lab.offset = lab.offset, ln.offset = ln.offset)
    },
    error=function(e){}
  )
}
```

Save the results

```{r}
pdf(file="phylogeny__output__birdlife_tree.pdf")
plot(birdlife_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.01, 0.5), lwd = c(0.1, 1), leg.txt="Cities/Regional Pools")

for(family in unique(birdlife_input$birdlife_v3_family_name_english)) {
  col = "black"
  lab.offset = 1.04
  ln.offset = 1.00
  
  if (family %in% birdlife_jitter_down) {
    lab.offset = 1.025
  }
  
  if (family %in% birdlife_jitter_up) {
    lab.offset = 1.055
  }
  
  if (family %in% birdlife_jitter_up_up) {
    lab.offset = 1.07
  }
  
  if (family %in% birdlife_jitter_up_up_up) {
    lab.offset = 1.085
  }
  
  if (family %in% birdlife_jitter_down_down) {
    lab.offset = 1.01
  }
  
  tips <- birdlife_input$jetz_scientific_name[birdlife_input$birdlife_v3_family_name_english == family]
  node <- findMRCA(tree, tips)
  tryCatch(
    expr = {
      arc.cladelabels.fixed(text=family, node=node, tree = tree, cex = 0.2, mark.node = F, col = col, lab.offset = lab.offset, ln.offset = ln.offset)
    },
    error=function(e){}
  )
}
dev.off()
```

Load Merlin regional pool and city data

```{r}
merlin_raw <- read_csv('./phylogeny__input__merlin_city_presence.csv')
```

Species from birdlife pool not in tree

```{r}
merlin_raw[!merlin_raw$jetz_scientific_name %in% tree$tip.label,]
```

Format birdlife data

```{r}
merlin_input <- merlin_raw[merlin_raw$jetz_scientific_name %in% tree$tip.label,]
merlin_pruned <- ladderize(drop.tip(tree, setdiff(tree$tip.label, merlin_input$jetz_scientific_name)))

merlin <- merlin_input$presence_ratio
names(merlin) <- merlin_input$jetz_scientific_name

head(merlin)
```

Run the analysis on merlin

```{r}
merlin_phylo_signal <- phylosig(merlin_pruned, merlin, method="lambda", test=TRUE)
merlin_phylo_signal
```

Show the results for merlin

```{r}
merlin_continuous_trait_evolution <- contMap(merlin_pruned, merlin, outline=FALSE, fsize=0.05, lwd=0.3)
```

```{r}
colourCountM <- length(merlin_continuous_trait_evolution$cols)
merlin_continuous_trait_evolution$cols[1:colourCountM]<-colorRampPalette(c("#FFC20A","#0C7BDC"), space="Lab")(colourCountM)
```

```{r}
merlin_jitter_down = c('Orioles and figbirds', 'Long-tailed Tits', 'Honeyguides', 'Ground-hornbills', 'Sunbirds', 'Mockingbirds and thrashers', 'Ducks, geese and swans', 'Treecreepers', 'Guans and curassows', 'Grouse, pheasants and partridges', 'Starlings', 'Jacanas', 'New World warblers', 'Antthrushes and antpittas', 'Pardalotes', 'Honeyeaters', 'Vireos and allies', 'Australasian babblers', 'Shrike-tits', 'Australasian wrens', 'Woodswallows', 'Shrike-flycatchers, wattle-eyes and batises', 'White-eyes', 'Woodpeckers', 'Pardalotes', 'Motmots', 'Sparrows, snowfinches and allies', 'Herons and egrets', 'Drongos', 'Trogons', 'Manakins', 'Babblers and parrotbills', 'Sandgrouse', 'Waxbills, grass finches, munias and allies', 'Sparrows, snowfinches and allies')

merlin_jitter_down_down = c('Pardalotes', 'Antthrushes and antpittas', 'Rollers', 'Buttonquails', 'Swallows and martins', 'Guineafowl', 'Shrike-flycatchers, wattle-eyes and batises', 'Turacos', 'Lyrebirds', 'Flowerpeckers', 'Penduline-tits', 'Tits and chickadees', 'Grosbeaks, saltators and allies', 'Helmetshrikes, bushshrikes and puffbacks', 'Accentors', 'Osprey, kites, hawks and eagles', 'Vireos and allies', 'Gnateaters', 'Dippers', 'Nightjars', 'Hummingbirds', 'Frogmouths', 'Finches and Hawaiian honeycreepers', 'New World quails')

merlin_jitter_up = c('Wrens', 'Screamers', 'Butcherbirds', 'Indigobirds and allies', 'Antbirds', 'Bee-eaters', 'Rails, crakes and allies', 'Tinamous', 'Cuckoo-shrikes', 'Storks', 'Painted-snipes', 'Wagtails and pipits', 'Weavers and allies', 'Puffbirds', 'Waxwings', 'Bustards', 'Australian treecreepers', 'Cuckoos', 'Crows and jays', 'Cotingas', 'Chats and Old World flycatchers', 'Flamingos', 'Parrots', 'Stilts and avocets', 'Thrushes', 'Honeyeaters', 'Doves and pigeons')

merlin_jitter_up_up = c('Larks', 'Goldcrests and kinglets', 'Broadbills', 'Butcherbirds', 'Woodhoopoes', 'Toucans and barbets', 'New World vultures', 'Anhingas', 'Australasian robins', 'Lyrebirds', 'Ibises and spoonbills', 'Whipbirds, wedgebills and jewel-babblers', 'Leafbirds', 'Shrikes', 'Thick-knees', 'Ovenbirds', 'Kingfishers', 'Cisticolas and allies', 'Old World warblers')

merlin_jitter_up_up_up = c('Oystercatchers', 'Pelicans', 'Jacamars', 'Buntings, American sparrows and allies', 'Falcons and caracaras')
```

```{r}
plot(merlin_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.01, 1), lwd = c(0.1, 1), leg.txt="Cities/Regional Pools")

for(family in unique(merlin_input$birdlife_v3_family_name_english)) {
  col = "black"
  lab.offset = 1.04
  ln.offset = 1.00
  
  if (family %in% merlin_jitter_down) {
    lab.offset = 1.025
  }
  
  if (family %in% merlin_jitter_up) {
    lab.offset = 1.055
  }
  
  if (family %in% merlin_jitter_up_up) {
    lab.offset = 1.07
  }
  
  if (family %in% merlin_jitter_up_up_up) {
    lab.offset = 1.085
  }
  
  if (family %in% merlin_jitter_down_down) {
    lab.offset = 1.01
  }
  
  tips <- merlin_input$jetz_scientific_name[merlin_input$birdlife_v3_family_name_english == family]
  node <- findMRCA(tree, tips)
  tryCatch(
    expr = {
      arc.cladelabels.fixed(text=family, node=node, tree = tree, cex = 0.2, mark.node = F, col = col, lab.offset = lab.offset, ln.offset = ln.offset)
    },
    error=function(e){}
  )
}
```

Save the results

```{r}
pdf(file="phylogeny__output__merlin_tree.pdf")
plot(merlin_continuous_trait_evolution, type="fan", outline=FALSE, fsize=c(0.01, 1), lwd = c(0.1, 1), leg.txt="Cities/Regional Pools")

for(family in unique(merlin_input$birdlife_v3_family_name_english)) {
  col = "black"
  lab.offset = 1.04
  ln.offset = 1.00
  
  if (family %in% merlin_jitter_down) {
    lab.offset = 1.025
  }
  
  if (family %in% merlin_jitter_up) {
    lab.offset = 1.055
  }
  
  if (family %in% merlin_jitter_up_up) {
    lab.offset = 1.07
  }
  
  if (family %in% merlin_jitter_up_up_up) {
    lab.offset = 1.085
  }
  
  if (family %in% merlin_jitter_down_down) {
    lab.offset = 1.01
  }
  
  tips <- birdlife_input$jetz_scientific_name[birdlife_input$birdlife_v3_family_name_english == family]
  node <- findMRCA(tree, tips)
  tryCatch(
    expr = {
      arc.cladelabels.fixed(text=family, node=node, tree = tree, cex = 0.2, mark.node = F, col = col, lab.offset = lab.offset, ln.offset = ln.offset)
    },
    error=function(e){}
  )
}
dev.off()
```
