---
title: "R Notebook"
output: html_notebook
---


```{r setup}
library(stringr)
library(tidyverse)
library(bigrquery)
library(MuMIn)
library(ggplot2)

library(ggpubr)

response <- try(system('~/google-cloud-sdk/bin/gcloud projects list --quiet', intern = T))
projectid <- strsplit(response[2], " ")[[1]][1]

options(na.action = "na.fail") 

source("./helper__dredge_functions.R")
```

----------------------------------
Trophic Niche Accumulation
----------------------------------

```{r}
accumulation <- read_csv('species_analysis__input__trophic_niche_accumulation.csv')
accumulation
```
```{r}
merlin_accumulation = ggplot(accumulation, aes(x = percent, y = merlin_niche_count)) + 
  geom_line(linetype = "dotted") + 
  geom_line(aes(linetype = merlin_remaining_species), na.value = "dash") +
  scale_linetype_manual(values=c("blank", "solid"), guide = "none") +
  geom_hline(data = . %>% group_by(trophic_niche) %>% filter(merlin_niche_count == max(merlin_niche_count)), aes(yintercept = merlin_niche_count), color = "blue", size = 0.25, linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "bottom", strip.text = element_text(size = 6), axis.text.x = element_text(angle = 90, size = 6),  axis.text.y = element_text(size = 6)) +
  facet_wrap (~ trophic_niche) +
  xlab("Percentage of all Species") + 
  ylab("Number of Niches") +
  labs(title = "Merlin Niche Accumulation")

merlin_accumulation
```


```{r}
birdlife_accumulation = ggplot(accumulation, aes(x = percent, y = birdlife_niche_count)) + 
  geom_line(linetype = "dotted") + 
  geom_line(aes(linetype = birdlife_remaining_species), na.value = "dash") +
  scale_linetype_manual(values=c("blank", "solid"), guide = "none") +
  geom_hline(data = . %>% group_by(trophic_niche) %>% filter(birdlife_niche_count == max(birdlife_niche_count)), aes(yintercept = birdlife_niche_count), color = "blue", size = 0.25, linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "bottom", strip.text = element_text(size = 6), axis.text.x = element_text(angle = 90, size = 6),  axis.text.y = element_text(size = 6)) +
  facet_wrap (~ trophic_niche) +
  xlab("Percentage of all Species") + 
  ylab("Number of Niches") +
  labs(title = "Birdlife Niche Accumulation")

birdlife_accumulation
```

----------------------
Total number of niches
----------------------
```{r}
by_max_birdlife_niche_count = accumulation %>% group_by(trophic_niche) %>% summarise(Value = max(birdlife_niche_count))
by_max_birdlife_niche_count[order(-by_max_birdlife_niche_count$Value),]
```

```{r}
ggplot(accumulation, aes(x = percent, y = merlin_niche_count)) + 
  geom_line(linetype = "dotted") + 
  geom_line(aes(linetype = birdlife_remaining_species), na.value = "dash") +
  scale_linetype_manual(values=c("blank", "solid"), guide = "none") +
  geom_hline(data = . %>% group_by(trophic_niche) %>% filter(merlin_niche_count == max(merlin_niche_count)), aes(yintercept = merlin_niche_count), color = "blue", size = 0.25, linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "bottom", strip.text = element_text(size = 6), axis.text.x = element_text(angle = 90, size = 6),  axis.text.y = element_text(size = 6)) +
  facet_wrap (~ factor(trophic_niche, levels = c("Invertivore", "Aquatic predator", "Omnivore", "Vertivore", "Frugivore", "Herbivore aquatic", "Granivore", "Herbivore terrestrial", "Nectarivore", "Scavenger")), scales = "free") +
  xlab("Percentage of total species\nordered by decreasing urban tolerance") + 
  ylab("Number of niches") +
  xlim(40, 0)



ggsave("species_analysis__output__trophic_niche_accumlation_merlin.jpg")
```
```{r}
ggplot(accumulation, aes(x = percent, y = birdlife_niche_count)) + 
  geom_line(linetype = "dotted") + 
  geom_line(aes(linetype = birdlife_remaining_species), na.value = "dash") +
  scale_linetype_manual(values=c("blank", "solid"), guide = "none") +
  geom_hline(data = . %>% group_by(trophic_niche) %>% filter(birdlife_niche_count == max(birdlife_niche_count)), aes(yintercept = birdlife_niche_count), color = "blue", size = 0.25, linetype = "dashed") +
  theme_bw() +
  theme(legend.position = "bottom", strip.text = element_text(size = 6), axis.text.x = element_text(angle = 90, size = 6),  axis.text.y = element_text(size = 6)) +
  facet_wrap (~ factor(trophic_niche, levels = c("Invertivore", "Aquatic predator", "Omnivore", "Vertivore", "Frugivore", "Herbivore aquatic", "Granivore", "Herbivore terrestrial", "Nectarivore", "Scavenger")), scales = "free") +
  xlab("Percentage of total species\nordered by decreasing urban tolerance") + 
  ylab("Number of niches") +
  xlim(40, 0)



ggsave("species_analysis__output__trophic_niche_accumlation_birdlife.jpg")
```


```{r}
urban_niche_counts <- read_csv("species_analysis__input__birdlife_urban_niche_counts.csv")
urban_niche_counts
```

------------------------------------------------
Results table for number of urban niches
------------------------------------------------
```{r}
birdlife_compare_counts <- accumulation[accumulation$percent == 100, c("trophic_niche", "birdlife_niche_count")]
names(birdlife_compare_counts) <- c("trophic_niche", "total_niche_count")

birdlife_compare_counts$trophic_niche <- factor(birdlife_compare_counts$trophic_niche)
birdlife_compare_counts

niche_count_data <- right_join(birdlife_compare_counts, urban_niche_counts)


niche_count_data$total_percent_urban <- niche_count_data$urban_niche_count / niche_count_data$total_niche_count

niche_count_data
```

```{r}
write_csv(niche_count_data, "species_analysis__output__niche_accumulation_results.csv")
```



-------------------------
Explore taxonomic families
-------------------------
```{r}
urbanite_families <- read_csv('species_analysis__input__urbanite_taxonomic_families.csv')
urbanite_families
```

```{r}
nrow(urbanite_families)
```

```{r, fig.width = 6}
families_ordered_by_birdlife <- urbanite_families$taxonomic_family[order(urbanite_families$birdlife_city_ratio)]
urbanite_families$taxonomic_family = factor(urbanite_families$taxonomic_family, levels=families_ordered_by_birdlife)

                  
ggplot(urbanite_families, aes(y = birdlife_city_ratio * 100, x = taxonomic_family)) + 
  geom_point() +
  ylab("Percentage of cities\npresent when in\nregional pool") + xlab("Taxonomic Family") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=5)) 

ggsave("species_analysis__output__birdlife_taxonmic_families.jpg")
```
```{r, fig.width = 6, fig.height = 8}
families_ordered_by_merlin <- urbanite_families$taxonomic_family[order(urbanite_families$merlin_city_ratio)]
urbanite_families$taxonomic_family = factor(urbanite_families$taxonomic_family, levels=families_ordered_by_merlin)

                  
ggplot(urbanite_families, aes(y = merlin_city_ratio * 100, x = taxonomic_family)) + 
  geom_col( alpha = .2) +
  ylab("") + xlab("") +
  theme_bw() +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size=5)) +
  theme(axis.text.x = element_text(angle = 360/(2*pi) * rev( pi/2 + seq( pi/155, 2*pi-pi/155, len=155)))) +
  theme(panel.border = element_blank(),
        legend.key = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank()) +
  coord_polar(clip = "off")

ggsave("species_analysis__output__merlin_taxonmic_families.jpg")
```



